.PHONY: help start stop restart logs status verify test clean setup-replica full-setup

# Variables
DOCKER_COMPOSE = docker compose
DOCKER = docker

# Colores para output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

help:
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)  PostgreSQL Replication - Comandos Disponibles$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)Inicio y ConfiguraciÃ³n:$(NC)"
	@echo "  make full-setup    - ConfiguraciÃ³n completa automÃ¡tica (RECOMENDADO)"
	@echo "  make start         - Iniciar solo el nodo primario"
	@echo "  make setup-replica - Configurar y activar la rÃ©plica"
	@echo ""
	@echo "$(YELLOW)Control de Contenedores:$(NC)"
	@echo "  make stop          - Detener todos los contenedores"
	@echo "  make restart       - Reiniciar todos los contenedores"
	@echo "  make status        - Ver estado de contenedores"
	@echo ""
	@echo "$(YELLOW)Logs y Monitoreo:$(NC)"
	@echo "  make logs          - Ver logs de todos los contenedores"
	@echo "  make logs-primary  - Ver logs solo del primario"
	@echo "  make logs-replica  - Ver logs solo de la rÃ©plica"
	@echo ""
	@echo "$(YELLOW)VerificaciÃ³n y Pruebas:$(NC)"
	@echo "  make verify        - Verificar estado de replicaciÃ³n"
	@echo "  make test          - Probar replicaciÃ³n insertando datos"
	@echo ""
	@echo "$(YELLOW)Acceso a Base de Datos:$(NC)"
	@echo "  make shell-primary - Conectar a PostgreSQL primario"
	@echo "  make shell-replica - Conectar a PostgreSQL rÃ©plica"
	@echo ""
	@echo "$(YELLOW)Utilidades:$(NC)"
	@echo "  make backup        - Crear backup de la base de datos"
	@echo "  make clean         - Limpiar todo (Â¡cuidado!)"
	@echo ""
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"

full-setup:
	@echo "$(GREEN)ðŸš€ Iniciando configuraciÃ³n completa...$(NC)"
	@chmod +x setup-all.sh
	@./setup-all.sh

start:
	@echo "$(GREEN)ðŸš€ Iniciando contenedores...$(NC)"
	$(DOCKER_COMPOSE) up -d postgres-primary pgadmin
	@echo "$(YELLOW)â³ Esperando a que el primario estÃ© listo...$(NC)"
	@sleep 15
	@echo ""
	@echo "$(GREEN)âœ… Primario iniciado$(NC)"
	@echo "$(YELLOW)âš ï¸  IMPORTANTE: Ejecuta 'make setup-replica' para configurar la rÃ©plica$(NC)"

setup-replica:
	@echo "$(GREEN)ðŸ”§ Configurando rÃ©plica...$(NC)"
	@chmod +x scripts/configure-replica.sh
	@bash scripts/configure-replica.sh
	@echo ""
	@sleep 5
	@make verify

stop:
	@echo "$(RED)ðŸ›‘ Deteniendo contenedores...$(NC)"
	$(DOCKER_COMPOSE) down

restart:
	@make stop
	@sleep 2
	@make start

logs:
	$(DOCKER_COMPOSE) logs -f

logs-primary:
	$(DOCKER) logs -f postgres-primary

logs-replica:
	$(DOCKER) logs -f postgres-replica

status:
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ“Š Estado de Contenedores$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@$(DOCKER_COMPOSE) ps

verify:
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo "$(GREEN)ðŸ” Verificando Estado de ReplicaciÃ³n$(NC)"
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“Š Estado en PRIMARIO:$(NC)"
	@$(DOCKER) exec postgres-primary psql -U postgres -c "SELECT application_name, state, sync_state FROM pg_stat_replication;" || echo "$(RED)âŒ No hay rÃ©plicas conectadas$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“Š Estado en RÃ‰PLICA (debe mostrar 't'):$(NC)"
	@$(DOCKER) exec postgres-replica psql -U postgres -c "SELECT pg_is_in_recovery();" || echo "$(RED)âŒ RÃ©plica no disponible$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“Š Datos en PRIMARIO:$(NC)"
	@$(DOCKER) exec postgres-primary psql -U postgres -d testdb -c "SELECT * FROM test_replication;" || echo "$(RED)âŒ No se pudo consultar$(NC)"
	@echo ""
	@echo "$(YELLOW)ðŸ“Š Datos en RÃ‰PLICA:$(NC)"
	@$(DOCKER) exec postgres-replica psql -U postgres -d testdb -c "SELECT * FROM test_replication;" || echo "$(RED)âŒ No se pudo consultar$(NC)"
	@echo ""
	@echo "$(BLUE)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(NC)"

test:
	@chmod +x scripts/test-replication.sh
	@bash scripts/test-replication.sh

clean:
	@echo "$(RED)âš ï¸  Â¿EstÃ¡s seguro? Esto eliminarÃ¡ TODOS los datos.$(NC)"
	@echo "$(RED)    Presiona Ctrl+C en los prÃ³ximos 5 segundos para cancelar...$(NC)"
	@sleep 5
	$(DOCKER_COMPOSE) down -v
	@echo "$(GREEN)ðŸ—‘ï¸  Limpieza completada$(NC)"

shell-primary:
	@echo "$(GREEN)ðŸ˜ Conectando a PostgreSQL PRIMARIO...$(NC)"
	$(DOCKER) exec -it postgres-primary psql -U postgres -d testdb

shell-replica:
	@echo "$(GREEN)ðŸ˜ Conectando a PostgreSQL RÃ‰PLICA...$(NC)"
	$(DOCKER) exec -it postgres-replica psql -U postgres -d testdb

backup:
	@echo "$(GREEN)ðŸ’¾ Creando backup...$(NC)"
	@$(DOCKER) exec postgres-primary pg_dump -U postgres testdb > backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… Backup creado: backup_$$(date +%Y%m%d_%H%M%S).sql$(NC)"

# Comandos adicionales Ãºtiles
ps:
	@$(DOCKER_COMPOSE) ps

top:
	@$(DOCKER_COMPOSE) top

stats:
	@$(DOCKER) stats postgres-primary postgres-replica

network:
	@$(DOCKER) network inspect replicacion-postgres_postgres-network

volumes:
	@$(DOCKER) volume ls | grep replicacion-postgres

inspect-primary:
	@$(DOCKER) inspect postgres-primary

inspect-replica:
	@$(DOCKER) inspect postgres-replica
